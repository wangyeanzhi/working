---
title: 搜表
tags: vs
notebook: hplc
---
全业务流程设计中，对这些流程做了详细的要求，比深化应用实现那个文档详细很多。


#### 搜表分为两种
* 周期搜表，通过配置配置参数，能源控制器自动周期搜表。 6002属性9和属性8
* 立即搜表。主站下发启动搜表命令，能源控制器立即搜表。 6002方法127

#### 周期搜表
*  

2020-11-4</br>
今天把搜表做完，md。

看文档最多看到10点。

**这个实时启动搜表确实是自己理解有问题，林哥在深化应用实现中已经明确了这个问题，是自己么有注意到。**
这个地方是我忘了，当时确实也是这么处理的。

#### 立即启动搜表

* 主站下发启动命令(60027f00)，设置搜表时长
* 居民用电与任务调度通信(1003-0012)，设置搜表时长
* 任务调度收到mqtt消息，解析搜表时长，执行搜表任务(操作和代理是一样的)
* 要读取(60020800)的参数，根据参数清空搜表结果。(如果没有配置，则默认清空)
* 启动一个搜表任务，操作路由：暂停路由，激活从节点注册
* 等待搜表结果，查重，存入到数据中心
* 数据中心给出通知，居民用电来读取搜表结果，根据搜表参数生成电表档案。
* 更新数据中心的采集档案
* 根据搜表结果，生成未知电能表事件，写入数据中心。这个事件还需要上报主站，主站核对下发档案
* 每天23点30分后，不允许搜表，暂停搜表，停止从节点注册

#### 周期搜表

* 任务调度启动后，要主动从数据中心读取周期搜表参数，当这个参数变动时，也要在数据中西同步
* 会判断是不是当前时间可以搜表
* 要读取(60020800)的参数，根据参数清空搜表结果。(如果没有配置，则默认清空)
* 启动一个搜表任务，操作路由：暂停路由，激活从节点注册
* 采集任务调度管理 APP 接收“上报搜表数据”消息，生成“搜表结果”记录，写入数据中心
* 低压集抄 APP 通过订阅数据中心的数据更新事件，当“搜表结果”有更新，读出搜表结果记录，并根据“搜表参数”确定是否更新采集档案，同时生成“发现未知电能表事件”存储并上报用采主站
* 用采主站收到“发现未知电能表事件”，档案核对无误后，可主动给终端下发添加档案命令


#### 具体实现分析

这两个是添加任务：</br>
* 上行接口，60027f00设置搜表时长，(这个地方，参考处理代理，发送和解析mqtt得到数据那一套)，解析时长，添加任务
* 任务调度一上电就要读取搜表参数，(要参考一下，一上电读参数是怎么处理的)，设置600208/09更新到数据心中，任务调度来读，并添加任务。

2020年11月4日09:34:54分析文档结束。
**以前并没有看主分支的代码是如何实现的，还是需要一定的时间来看主分支的处理。**

在上午下班之前，要把程序思路给确定了：
*  接收“上报搜表数据”消息，这一步原先我认为是在状态机中处理的，但是应该 gw3762_afnfn_lbl 在这里面，对上报的376.2报文，进行了处理，并没有到状态机那一步
  
#### 存在的疑惑

1. 在添加任务之前，上行接口的处理
   * 问题1，任务调度如何上电读60000800的？
     * db_sync_normal_data在这个函数中，是mqtt连接成功后，同步参数，这个参数同步到本地数据库，给出通知，添加任务。
   * 问题2，在什么时候读取60020800这个参数？
     * 在任务执行之前，读一下这个参数，在任务那地方好像有个初始化的函数，不知道放哪里行不行，参考抄表任务
   * 问题3：几点思考？
     。。。
2. 状态机中处理
    * 在pre_run中，要对任务的周期进行处理。
    * 状态机中要完成的任务
      * 暂停路由
      * 下发从节点主动注册
      * 然后，等待上报，这一步并不是在状态机中处理，是在收到376.2报文的地方直接处理，不进入状态机中。


#### 临时记录函数

* schmt_ctrl_para， 通过这个参数包含了清空表结果。
* sys_6002_para --> sys_skmt_para --> clear_result, 08的参数又是怎么到它？
    * 这里应该是主分支参数的处理方式，把08的这个参数转化到了sys_6002_para这里面。
* del_searchmt_file， 注意这个函数在什么地方用到了？
* searchmt_start_init
* set_task_real_start_sec
* travel_task_period

主分支中的函数：
* local_receive_process 收到376.2报文处理的函数

#### 搜表主分支处理
- [x] 在3点之前结束

现在存在的问题就是，对主分支结构不熟，不知道挂到链表上又是怎么处理的？</br>
也只有慢慢的搜着函数去找。多思考用到了什么就找着关联去搜索。

如果是真的去写代码的话，必须要弄明白主分支是怎么处理的！！  
1. 先分析流程
先暂停路由，激活从节点注册</br>
这里有一个处理的逻辑，激活从节点注册后，等待上报并确认，但是10分未上报注册信息，下发10-f4根据运行状态字中的“工作标志”状态决定是否继续上报；或收到路由主动上报的“路由工况变动信息”（AFN=06H-F3），获知主动注册已经结束，回复确认报文（AFN=00H-F1）后终止主动注册流程

问题：</br>
在现在程序中，怎么处理？等待上报  
现在有个问题是，等待这个10分钟和上报数据是怎么联系的？  
**这个地方的处理，应该是没有联系的，就是不管收不收到数据都会到了10分钟就下发，如果是工作标志正常就不用管，继续等待直到搜表时间到。**

* now_end_register_flow
* clr_all_register_flow_para -->

本地模块搜到的表挂在链表上，  
* get_schmt_pnode_from_thread_queue
* get_schmt_from_link_and_handle，从缓存搜表结果的链表上取表信息存文件或者加入表档案处理
* sys_sec_action，在这个秒任务里会不断的从链表上去下任务来处理，从下到上，就是搜表结果挂到链表上的处理
* 

**2020-11-4 14:37:50 主分支代码的逻辑理清**  
但是，细节的处理，我在理解上还差的很多

#### 程序设计
* 状态机
  1. 暂停路由
  2. 激活从节点注册 等待这个10分钟，但是这个时间是怎么等待呢？
  3. 主分支是每隔10min查一次？在op1中等待？


2020-11-4 15:06:54 开始写代码  
#### 处理上行接口
6002_08/09/127  
这部分是一直到添加任务搜表任务。包含：  
* 6002_127接口，1003-0012，添加任务这部分可以参考代理部分
* 任务调度上电要同步6000_09,周期搜表参数添加任务
* 6002_08/09参数写入到数据中心，数据中心给出通知，添加任务

- [ ] 5点半以前完成上行接口的处理，最好在理清pre_run那个地方

开始
* 6012_127 2020-11-4 15:38:25 ---> 

##### 代理部分处理   
* tskm_proxy_msg_send
* adr_code_send_proxy

要看明白handle_proxy

在处理mqtt传到任务调度的数据的时候，可以参考代理添加任务的方法。

##### 处理任务调度上电读取60020900

处理流程：上电通过db_sync_normal_data这个函数在数据中心同步60020900的参数，并把参数写入本地数据库，本地数据库给出通知，然后添加任务。

* 现有程序是处理了60020900的默认参数的， 在 struct sys_para_block para_tab 这里
* 

##### md，任务调度的流程都有些理不清了
流程：  
* cmsg.cmd == APP_MSG_DB_SYNC_DONE  on_db_sync_done
* on_mqtt_ready
* dbsync_msg_ccb_cb  db_sync_loop  dbsync_setup
* DB_SYNC_MSG_MQTT_READY  app_on_mqtt_conn  mqtt_clt_ops
* DB_SYNC_MSG_DBCENTER_UPDATE handle_update_event 0005-0001数据更新事件

**程序有一个同步的线程，用来同步数据中心的数据项**

* mqtt连接后，会设置标志 DB_SYNC_MSG_MQTT_READY，在同步的时候会根据这个标志，来同步数据项，这就是上电在数据中心同步的地方。从数据中心读出，存入到本地数据库 db_sync_one_infoseq(这个是在mqtt建立连接的时候)
  
* 当有数据写入到数据中心，给出数据更新事件，任务调度订阅，收到并处理 db_sync_one_infoseq，同步参数的时候和上面一个用的是相同的函数
  
* 还有一个同步项是同步的数据中心的初始化事件

首先要明白的是这个同步的线程，完成的是和数据中心的同步，根据不同的标志，来把数据中心的数据读出来，存入到本地数据库。

在上电同步以后，会设置标志APP_MSG_DB_SYNC_DONE，

**存入到本地数据库后，又有一个流程，那是一个监测本地数据库变动的**
* 

有一个地方没有看明白，如果是通过数据更新事件同步的写入到本地数据库是怎么给出通知？
**这个地方，具体并没有找到如何处理，但是可以确定不是和上电同步是一起的，这个是在处理数据库变更的时候，执行app_code_db_msg这个函数，具体的在哪里调用的并没有找到**  

**这个地方应该是有一个误区，我认为任务调度在一上电同步数据中心的参数，并把数据中心的参数写入到数据库，会引起本地数据库给出通知，从而可以根据同步的参数来添加任务， 现在看来是有问题的，**
**在同步参数后，会设置标志APP_MSG_DB_SYNC_DONE，然后才会进入，on_db_sync_done并在这个函数中添加mdb->db->update_event数据变更的监测，所以说在一上电同步写入本都数据库的变更并不会被监测，这就是解决了上面不明白的地方**

先做功能，后续有时间再去处理。


##### 继续处理任务调度上电读取60020900

本地数据库变更了先到app_code_db_msg，在这里给出通知，最后再处理变更。  
最简单的方法是现在不做这个上电就读，先去解决其他的接口。
**看到默认参数给的是0，可以判断一下读出来的是不是0，来添加任务吧？**

先做08/09的上行接口，

##### 处理09的set与get
09接口已经做好，不知道为什么一开始下进去的时候，会挂掉程序，后续没有出现。

这里有一个地方，是么有考虑到的，就是08为什么也要添加搜表任务，08有一个是否每天起用周期搜表，要根据这个判断一下是否添加搜表任务，所以在09要读一下08，同理08要读一下09，能不能把情况标志也给传过去？

现在已经完成上行接口的调试，都可以正常的添加搜表任务。

#### 处理状态机
还是需要再去分析  

现有任务还可以分成三部分：
* 状态机下发命令控制路由
* 收到数据存储到数据中心
* 居民用电生成事件

首先完成状态机的部分(用两个小时)  
* 要组一个任务周期，周期的和立即的要不同的处理(根据传参的不同，好处理)
* 清空这个地方如何处理(还没有想好是怎么处理)
* 各种状态，那个等待怎么处理？要每隔10分钟处理一下那个地方？(要问华哥)

##### 状态机处理状态

还是要在看一下376.2协议最后的处理部分,   
首先下发暂停和激活从节点, 这里没有问题  
集中器收到06h-f4和06h-f1, 这个是在另一个地方处理, 并不是在状态机中  
每隔10分钟,下发10-f4,查询路由运行状态,**隔一段时间去查询一下路由，搜表是不是完成**  
06h-f3 路由主动上报, 获知主动注册已经结束  
**还需要档案同步?**  

600208中有个自动更新采集档案,不知道怎么用? 这个应该是在数据处理的时候来判断

* 状态1, 暂停路由 ---> 状态2 激活从节点注册
* 状态2, 激活从节点注册 ---> 状态3 等待并执行查询路由状态
* 状态3, 在op1中等待, 这个可以吗, 10分钟, 下发查询路由状态, op2判断, 若继续则 切换状态3, 若到搜表时间, ----> 状态4 停止从节点注册

##### 清空
这个清空是在发送暂停路由之前.

综上, 已经知道大体是怎么做了, 还是需要些代码的时候, 在仔细的看具体处理.
华哥给说了一遍,这么理解是正确的.

还以为4点能结束这一部分,结果延迟到5点半...

开始处理程序.
还是得看看主分支的处理,不能想当然.

有一个难点,就是在op1中等待.

#### 任务中时间的问题,cce->parent.tl.now
* 首先会每秒更新一下这个时间,然后进入调度
* 明确一个地方, 就是pre_run在执行完以前,调度函数是不会重复进入pre_run的
* 也就是把这个时间可以在op中赋值,这个now会不断的变化,但是赋值的数不变


这里面,有一个地方么有转过来,就是op1 return后的后续,单纯的去写一个return, 看着就有点懵, 但是下发376.2报文也是用的return. 
这个问题还是切换的问题, 就三个情况可以触发状态机调度, 设置状态机的状态, 定时时间到, 收到数据, 和return没有关系.

关于时间等待:
如果在op1中, return wait, 那么就什么也不会做等到超时进入op2. 

现在想实现的是, 
判断一下时间,时间不到,return 0, 直接等超时,超时可以设置wait为10分钟,也就是10分钟后会

D:\Working\流程图\fsm.drawio (先选中这个路径,然后ctrl+e,快速打开这个文件)

大体思路定了,还是存在一些细节的问题.

一会要测一下时间.
* put_le_val用小端的话, 那么就要用get_le_val是一一对应的
* 把时间都放在op1中,那么每次进入op1都会更改这个值,所以是不可以的,那么把这个时间放在上一个状态的op2
完美把时间问题解决给自己点个赞!!!!

开心不过三秒,我连这个流程还没走完,也就是本该昨天五点结束的内容.

测试流程的时候,有个问题,就是上报的内容没有处理,导致切换了状态机


2020-11-6 13:05:28 今天要完成搜表, 全部完成则回家.若到10点未完成则带电脑回家.

#### 处理数据存入到数据中心
在全业务流程的文档中,只有一句存入到将上报的数据存入到数据中心, 而在深化应用实现文档,有着详细的要求.

分析要求:  
* 要对搜表结果查重, 现在还不知道查重是怎么处理, 要参考林哥的一些处理
* 要把 一个搜表结果 的结构体写入到数据中心
* 写入的时候按普通数据结构存入, 读取按记录型接口获取  这个是何作用
* 还有6006/6007的户表新增标识是何作用

首先,把







